<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Authorization</title>
    <link rel="icon" href="public/Untitled_logo_1_free-file.jpg" />
    <link rel="stylesheet" href="styles/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Monomakh&family=Roboto:ital,wght@0,100..900;1,100..900&family=Wix+Madefor+Display:wght@400..800&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="progress"></div>
    <div class="cookies">
      <h3>TO PROCEED FURTHER, PLEASE AGREE TO THE PRIVACY POLICYüç™</h3>
      <button id="agree-with-cookies">okey</button>
    </div>
    <div class="container">
      <div id="login-form" class="auth-form">
        <h2>LOG IN TO VIDEOSCOP</h2>
        <form id="login">
          <div class="email">
            <input
              type="text"
              id="login-email"
              placeholder="Login"
              required
              minlength="3"
              maxlength="50"
            />
          </div>
          <div class="password">
            <input
              type="password"
              minlength="8"
              id="login-password"
              placeholder="Password"
              required
            />
          </div>
          <label class="remember-label">
            <input
              type="checkbox"
              id="remember-me"
              style="margin-right: 12rem"
            />
            <div class="remember">
              REMEMBER <span style="margin-right: 0.3rem"></span>ME
            </div>
          </label>
          <div class="privacy-policy">
            <label for="login-agree" style="display: flex; align-items: center">
              <input
                type="checkbox"
                id="login-agree"
                required
                style="margin-left: 0.6rem"
              />
              <div class="policy">
                I AGREE TO <a href="#" target="_blank">PRIVACY POLICY</a> AND
                <a href="#" target="_blank">DATA PROCESSING</a>
              </div>
            </label>
          </div>
          <button type="submit" class="login-btn">LOG IN</button>
          <a href="#" id="forgot" style="margin-bottom: 0.5rem"
            >FORGOT PASSWORD?</a
          >
        </form>
        <label for="show-register" id="dont-have-acc">
          DON'T HAVE AN ACCOUNT?
        </label>
        <button
          id="show-register"
          style="margin-top: 0.5rem"
          class="signup-btn"
        >
          SIGN UP
        </button>
        <div
          class="guest"
          style="opacity: 0.8; font-size: 1rem; font-weight: 500"
        >
          <span>OR LOG IN AS A</span>
          <a id="guest-login" style="margin-bottom: 1rem" href="#">GUEST</a>
        </div>
      </div>

      <div
        id="register-form"
        class="auth-form sign-up-container"
        style="display: none"
      >
        <h2>SIGN UP TO VIDEOSCOP</h2>
        <form id="register">
          <input
            type="text"
            id="register-username"
            placeholder="Username"
            required
            minlength="3"
            maxlength="50"
          />
          <input
            type="email"
            id="register-email"
            placeholder="Email"
            required
          />
          <div class="password">
            <input
              type="password"
              minlength="8"
              id="register-password"
              placeholder="Password"
              required
            />
          </div>
          <div class="privacy-policy">
            <label
              for="register-agree"
              style="display: flex; align-items: center"
            >
              <input
                type="checkbox"
                id="register-agree"
                required
                style="margin-left: 0.6rem"
              />
              <div class="policy">
                I AGREE TO <a href="#" target="_blank">PRIVACY POLICY</a> AND
                <a href="#" target="_blank">DATA PROCESSING</a>
              </div>
            </label>
          </div>
          <button type="submit" class="signup-btn">Sign up</button>
        </form>
        <button id="show-login" class="signup-btn">Back to log in</button>
      </div>
      <p class="error">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          class="error-svg"
          viewBox="0 0 24 24"
        >
          <path
            fill="currentColor"
            d="M12.5 8.752a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0Z"
          />
          <circle cx="11.999" cy="16.736" r=".5" fill="currentColor" />
          <path
            fill="currentColor"
            d="M18.642 20.934H5.385a2.5 2.5 0 0 1-2.222-3.644L9.792 4.421a2.5 2.5 0 0 1 4.444 0l6.629 12.869a2.5 2.5 0 0 1-2.223 3.644M12.014 4.065a1.478 1.478 0 0 0-1.334.814L4.052 17.748a1.5 1.5 0 0 0 1.333 2.186h13.257a1.5 1.5 0 0 0 1.334-2.186L13.348 4.879a1.478 1.478 0 0 0-1.334-.814"
          />
        </svg>
        ERROR! Incorrect password
      </p>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // —ç–ª–µ–º–µ–Ω—Ç—ã DOM
        const loginForm = document.getElementById('login');
        const registerForm = document.getElementById('register');
        const guestLoginBtn = document.getElementById('guest-login');
        const showRegisterBtn = document.getElementById('show-register');
        const showLoginBtn = document.getElementById('show-login');
        const loginDiv = document.getElementById('login-form');
        const registerDiv = document.getElementById('register-form');
        const container = document.querySelector('.container');
        const cookies = document.querySelector('.cookies');
        const errorElement = document.querySelector('.error');

        // —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏
        function showError(message) {
          errorElement.innerHTML = `
          <svg
    xmlns="http://www.w3.org/2000/svg"
    width="24"
    height="24"
    class="error-svg"
    viewBox="0 0 24 24"
  >
    <path
      fill="currentColor"
      d="M12.5 8.752a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0Z"
    />
    <circle cx="11.999" cy="16.736" r=".5" fill="currentColor" />
    <path
      fill="currentColor"
      d="M18.642 20.934H5.385a2.5 2.5 0 0 1-2.222-3.644L9.792 4.421a2.5 2.5 0 0 1 4.444 0l6.629 12.869a2.5 2.5 0 0 1-2.223 3.644M12.014 4.065a1.478 1.478 0 0 0-1.334.814L4.052 17.748a1.5 1.5 0 0 0 1.333 2.186h13.257a1.5 1.5 0 0 0 1.334-2.186L13.348 4.879a1.478 1.478 0 0 0-1.334-.814"
    /></svg>
            ERROR! ${message}
          `;
          errorElement.style.display = 'flex';
          setTimeout(() => (errorElement.style.display = 'none'), 5000);
        }

        document
          .getElementById('agree-with-cookies')
          .addEventListener('click', function () {
            cookies.classList.remove('clicked');
            container.style.opacity = '1';
            document.querySelector('.login-btn').disabled = false;
            document.querySelector('.signup-btn').disabled = false;
            document.getElementById('login-agree').disabled = false;
            document.getElementById('remember-me').disabled = false;
            guestLoginBtn.disabled = false;
          });

        showRegisterBtn.addEventListener('click', function () {
          loginDiv.style.display = 'none';
          registerDiv.style.display = 'block';
          errorElement.style.display = 'none';
        });

        showLoginBtn.addEventListener('click', function () {
          registerDiv.style.display = 'none';
          loginDiv.style.display = 'block';
          errorElement.style.display = 'none';
        });

        loginForm.addEventListener('submit', async function (e) {
          e.preventDefault();

          if (!document.getElementById('login-agree').checked) {
            return showError('—Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –Ω–∞–¥–æ —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è');
          }

          
          const guestData = {
            login: 'guest@videoscop.com',
            password: 'guestpassword',
          };


          const loginData = {
            login: document.getElementById('login-email').value.trim(),
            password: document.getElementById('login-password').value.trim(),
          };

          if (!loginData.login || !loginData.password) {
            return showError('–Ω–µ –≤—Å–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –±—Ä–∞—Ç–∞–Ω');
          }

          try {
            const response = await fetch(
              'http://217.114.10.197:8000/users/me/token',
              {
                method: 'POST',
                mode: 'cors',
                headers: {
                  'Content-Type': 'application/json',
                  Accept: 'application/json',
                },
                body: JSON.stringify(loginData),
              }
            );



            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.detail || 'Login failed');
            }

            const { access_token } = await response.json();
            localStorage.setItem('videoscop_token', access_token);
            window.location.href = 'home.html';
          } catch (error) {
            if (error.message.includes('Failed to fetch')) {
              showError('–ø—Ä–æ–ª–µ–º–∞ —Å–æ —Å–≤—è–∑—å—é');
            } else {
              showError(error.message || 'Login error');
            }
            console.error('Login error:', error);
          }
        });

        registerForm.addEventListener('submit', async function (e) {
          e.preventDefault();

          if (!document.getElementById('register-agree').checked) {
            return showError('—Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –Ω–∞–¥–æ —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è');
          }

          const registerData = {
            login: document.getElementById('register-username').value.trim(),
            email: document.getElementById('register-email').value.trim(),
            password: document.getElementById('register-password').value.trim(),
          };

          try {
            const response = await fetch('http://217.114.10.197:8000/users', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(registerData),
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.message || 'Registration failed');
            }

            const loginResponse = await fetch(
              'http://217.114.10.197:8000/users/me/token',
              {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  login: registerData.login,
                  password: registerData.password,
                }),
              }
            );

            if (!loginResponse.ok) throw new Error('Auto login failed');

            const { access_token } = await loginResponse.json();
            sessionStorage.setItem('videoscop_token', access_token);
            window.location.href = 'home.html';
          } catch (error) {
            console.error('Registration error:', error);
            showError(error.message || 'Registration error');
          }
        });

        guestLoginBtn.addEventListener('click', function () {
          if (!document.getElementById('login-agree').checked) {
            cookies.style.display = 'flex';
            return;
          }

          sessionStorage.setItem('videoscop_guest', 'true');
          localStorage.removeItem('videoscop_token');
          sessionStorage.removeItem('videoscop_token');

          window.location.href = 'home.html';
        });

        function checkAuth() {
          const token =
            localStorage.getItem('videoscop_token') ||
            sessionStorage.getItem('videoscop_token');
          if (token) {
          }
        }

        checkAuth();
      });
    </script>
  </body>
</html>
